rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // NOTIFICAÇÕES (Sistema Unificado V2)
    // ============================================

    // Collection única de notificações
    match /notifications/{notifId} {
      // Leitura: se usuário está em destinatarios ou é "TODOS"
      allow read: if request.auth != null &&
                     (resource.data.destinatarios.hasAny([request.auth.uid, 'TODOS']));

      // Escrita: apenas admin
      allow write: if request.auth != null && hasAdminRole();

      // Subcollection user_states (estado por usuário)
      match /user_states/{userId} {
        // Cada usuário pode ler/escrever apenas seu próprio estado
        allow read, write: if request.auth != null && userId == request.auth.uid;
      }
    }

    // ============================================
    // NOTIFICAÇÕES ANTIGAS (manter para migração gradual)
    // ============================================

    // In-app notifications (antigas)
    match /in_app_notifications/{notifId} {
      allow read: if request.auth != null &&
                     (resource.data.userId == request.auth.uid ||
                      resource.data.recipientUserIds.hasAny([request.auth.uid]));
      allow write: if request.auth != null && hasAdminRole();
    }

    // EAD push notifications (antigas)
    match /ead_push_notifications/{notifId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && hasAdminRole();
    }

    // Global push notifications (antigas)
    match /global_push_notifications/{notifId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && hasAdminRole();
    }

    // ============================================
    // USER STATES (estado de notificações antigas)
    // ============================================

    match /user_states/{userId} {
      allow read, write: if request.auth != null && userId == request.auth.uid;

      // Subcollections de estado por notificação
      match /{allPaths=**} {
        allow read, write: if request.auth != null && userId == request.auth.uid;
      }
    }

    // ============================================
    // USERS
    // ============================================

    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
                      (userId == request.auth.uid || hasAdminRole());
    }

    // ============================================
    // OUTRAS COLLECTIONS (exemplos)
    // ============================================

    // Cursos EAD
    match /cursos/{cursoId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && hasAdminRole();

      match /{document=**} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && hasAdminRole();
      }
    }

    // Grupos EAD
    match /grupos/{grupoId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && hasAdminRole();
    }

    // Tickets
    match /tickets/{ticketId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ============================================
    // FCM PUSH NOTIFICATIONS (Cloud Functions)
    // ============================================

    // Collection para envio de push notifications via FCM
    // Usada pelas Cloud Functions (firebase/functions/index.js)
    match /ff_push_notifications/{notifId} {
      // Leitura: apenas admin
      allow read: if request.auth != null && hasAdminRole();
      // Escrita: apenas admin (para criar notificações)
      allow write: if request.auth != null && hasAdminRole();
    }

    // FCM Tokens (subcollection de users)
    // Armazena tokens de dispositivos para push notifications
    match /users/{userId}/fcm_tokens/{tokenId} {
      // Leitura: apenas o próprio usuário ou admin
      allow read: if request.auth != null &&
                     (userId == request.auth.uid || hasAdminRole());
      // Escrita: Cloud Functions (via addFcmToken)
      // A escrita é feita via Cloud Function que valida a autenticação
      allow write: if request.auth != null && userId == request.auth.uid;
    }

    // ============================================
    // HELPER FUNCTIONS
    // ============================================

    // Verifica se usuário é admin
    function hasAdminRole() {
      return request.auth != null &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
